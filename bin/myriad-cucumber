#!/usr/bin/env node

'use strict';

var Optimist = require('optimist');
var Debug = require('debug')('myriad-cucumber')
var MyriadCucumber = require('../lib/myriad_cucumber');

function exit(code) {
  Debug("Exiting with code " + code);

  if (process.stdout.write("")) {
    process.exit(code);
  }
  else {
    process.stdout.on('drain', function() {
      process.exit(code);
    });
  }
};

var optimist = Optimist
  .usage('Usage: $0 options')
  .options('h', {
    alias: 'help',
    describe: 'Displays this help message'
  })
  .options('c', {
    alias: 'config',
    default: './myriad-cucumber.js',
    describe: 'Path to the config file'
  })
  .options('s', {
    alias: 'myriad-server',
    describe: 'URL of the myriad-server'
  })
  .options('w', {
    alias: 'workers',
    default: 2,
    describe: 'Number of instances of cucumber to run in parallel'
  })
  .options('l', {
    alias: 'local-package',
    boolean: true,
    default: false,
    describe: 'For use when running myriad-server locally.  If true, use locally installed package instead of sending a tarball of the package to myriad-server'
  });
var argv = optimist.argv;

if (argv.help) {
  optimist.showHelp();
  exit(0);
}
else {
  var options = {
    myriadServerUrl: argv['myriad-server'],
    configFile: argv['config'],
    localPackage: argv['local-package'],
    workers: argv.workers
  };

  MyriadCucumber(options).run(function(err, report) {
    if (err) {
      Debug('Exiting');
      console.error(err);
      exit(1);
    }
    else {
      console.log(JSON.stringify(report));
      exit(0);
    }
  });
}
